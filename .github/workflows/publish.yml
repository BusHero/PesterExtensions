name: Publish to Powershell gallery
on: push
env:
  MODULE_PATH: .\src\PesterExtensions
  MODULE_MANIFEST_PATH: .\src\PesterExtensions\PesterExtensions.psd1
  DOTNET_CLI_TELEMETRY_OPTOUT: true 
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Generate Module manifest file
      run: .\setup.ps1
    - name: Updated module version
      run: .\update-version.ps1 -Path ${{ env.MODULE_MANIFEST_PATH }} -revision ${{ github.run_number }}
    - name: Run tests
      run: Invoke-Pester -Container @(New-PesterContainer -Path . -Data @{Revision = ${{ github.run_number }}})
    - name: Upload PowerShell module
      run: Publish-Module -Path ${{ env.MODULE_PATH }} -NuGetApiKey ${{ secrets.POWERSHELL_GALLERY_KEY }}
