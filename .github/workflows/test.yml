name: test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Find Tag
        id: tagger
        run: .\Get-GitTag.ps1 -OutVariable tag
      - name: Check release is present
        run: gh release view ${{ steps.tagger.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Get the previous version of the module
        id: version
        run: .\Get-ExistingPackageVersion.ps1 -OutVariable version
      - name: Clean up version
        id: clean_version
        run: |
          $version = '${{ steps.version.outputs.version }}'.Substring(1)
          "::set-output name=version::${Version}"
      - name: Check it's an incremental upgrade
        run: |
          . "${PSScriptRoot}\src\PesterExtensions\Public\Check-SemanticVersion.ps1"
          Check-SemanticVersion `
            -Current ${{ steps.clean_version.outputs.version }} `
            -Next ${{ steps.tagger.outputs.tag }} | Should -BeTrue
      - name: Install PesterExtensions
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module PesterExtensions -RequiredVersion 0.4.0.23
      - name: Generate Module manifest file
        run: .\setup.ps1 -Version ${{ steps.clean_version.outputs.version }}
      - name: Run tests
        run: .\tests.ps1 -Version ${{ steps.clean_version.outputs.version }}
